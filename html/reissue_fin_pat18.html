<?
 include "include/head_common.html";
/*
* 무료인 경우만 데이터 넣어줌
*/ 

/*print_r($_POST);
 exit;
 */
 
 // 스키구조요원(1-18기) 재발급 gd_seq=>gd4497
 if($_POST['seq']=='GD4494') $_POST['seq']='GD4497';

 $sql = "select  GD_SALE_ENDDT from t_goods where gd_seq = '{$_POST['seq']}' ";
 //echo $sql;exit;

 $sd_date = sql_fetch($sql);
 
 $sd_date = substr($sd_date['GD_SALE_ENDDT'],0,8);
 $rs_buyer_idkey = $_POST['birth1'].$_POST['birth2'].$_POST['birth3'];
 $rs_buyer_idkey = $rs_buyer_idkey ? $rs_buyer_idkey : $_POST['births'];

 $tel = $_POST['BuyerTel'] ? $_POST['BuyerTel'] : $_POST['tel1'].'-'.$_POST['tel2'].'-'.$_POST['tel3'];
 $rs_status = $_POST['PayMethod']=='CARD' || $_POST['PayMethod']=='BANK' || $_POST['tpay']=='free' ? "C" : "V"; // C -> 신청완료, V -> 입금대기, tpay => pay(유료), free(무료)
 $birth = $_POST['birth1'].'-'.sprintf("%02d",$_POST['birth2']).'-'.sprintf("%02d",$_POST['birth3']);
 
 if(!$_POST['birth1'] || !$_POST['birth2'] || !$_POST['birth3'])
  $birth = substr($_POST['births'],0,-4).'-'.substr($_POST['births'],-4,-2).'-'.substr($_POST['births'],-2); 


 //echo 'birth : ' . $birth;exit;


 if($_POST['tpay']=='free'){
  $_POST['OID'] = $_POST['seq'].date("YmdHis");
  $_POST['amount'] = '0';
  $_POST['BuyerName'] = $_POST['hname'] ? $_POST['hname'] : $_POST['BuyerName'];
 }

 $sql = "SELECT count(*) cnt FROM t_reserve where IDKEY='{$_POST['key']}' AND  GD_SEQ='{$_POST['seq']}' AND RS_BUYER_NAME='{$_POST['BuyerName']}' and RS_BUYER_TEL='{$_POST['BuyerTel']}' ";

 //echo $sql;exit;

 $chk = sql_fetch($sql);

 //if(!$chk['cnt']){
 
 $sql = "INSERT INTO  t_reserve SET
            IDKEY='{$_POST['key']}', GD_SEQ='{$_POST['seq']}', RS_SEQ='{$_POST['OID']}',
            RS_DATE='".G5_TIME_YMDHIS."', RS_SD_DATE='".$sd_date."', RS_BUYER_IDKEY='{$rs_buyer_idkey}', 
            RS_BUYER_NAME='{$_POST['BuyerName']}', RS_BUYER_EMAIL='{$_POST['BuyerEmail']}', RS_BUYER_TEL='{$tel}', 
            RS_BUYER_PWD = '{$_POST['passwd']}' ,  RS_BUYER_AMOUNT='{$_POST['amount']}' , RS_PERSON='1', 
            RS_STATUS = '{$rs_status}', RS_TOT_AMT = '{$_POST['amount']}', RS_BUYER_PHOTO='/member/".date('Y')."/".date('m')."/".date('d')."/{$_POST['uploadPhoto']}', 
            INSERT_IDKEY='$rs_buyer_idkey', INSERT_DT='".G5_TIME_YMDHIS."', LICENSE_NUM='{$_POST['license_num']}', etc='{$_POST['re_issue']}'
";
 //echo '<br>'.$sql;exit;
  if($_POST['tpay']=='free') sql_query($sql);
 //}

 $sql = "SELECT count(*) cnt FROM t_reserve_add_info where IDKEY='{$_POST['key']}' AND  GD_SEQ='{$_POST['seq']}' AND ADD_NAME_KOR='{$_POST['BuyerName']}' AND ADD_TEL='{$tel}'";
 //echo $sql;exit;

 $chk = sql_fetch($sql);

 //if(!$chk['cnt']){
 $_POST['hname'] = $_POST['hname'] ? $_POST['hname'] : $_POST['names']; 
 $sql = "INSERT INTO  t_reserve_add_info SET
            IDKEY='{$_POST['key']}', GD_SEQ='{$_POST['seq']}', RS_SEQ='{$_POST['OID']}',
            ADD_NAME_KOR='{$_POST['hname']}', ADD_NAME_ENG='{$_POST['ename']}', ADD_BIRTH='{$birth}', ADD_TEL='{$tel}',
            ADD_BELONG_TO='{$_POST['branch']}', ADD_ADDR_TYPE='{$_POST['part']}', ADD_ZIPCODE='{$_POST['zip']}',
            ADD_ADDR1 = '{$_POST['addr1']}' ,  ADD_ADDR2='{$_POST['addr2']}' , ADD_EXEMPT_TYPE='{$_POST['except']}',
            REGIST_DATE = '".G5_TIME_YMDHIS."' , ADD_WHAT='{$_POST['re_issue']}'
";
 //echo "<br>$sql";exit;
 if($_POST['tpay']=='free') sql_query($sql);
 //}
 
 if($_POST['tpay']=='free'){
  $pm_method = 'FREE';
  $_POST['TID'] = $_POST['OID'];
  $_POST['BuyerName'] = $_POST['hname'] ? $_POST['hname'] : $_POST['BuyerName'];
 }
 else{ 
  $pm_method = $_POST['PayMethod'] == 'CARD' ? 'CARD' : 'BANK'; 
 }
 
 $sql = "SELECT count(*) cnt FROM t_payment where IDKEY='{$_POST['key']}' AND RS_SEQ='{$_POST['OID']}' AND PM_TRANS_NO='{$_POST['TID']}'";
 //echo "<br>$sql";exit;
 $chk = sql_fetch($sql);
 
 //if(!$chk['cnt']){
 $sql = "INSERT INTO  t_payment SET
            IDKEY='{$_POST['key']}', RS_SEQ='{$_POST['OID']}', PM_PAY_METHOD='{$pm_method}', 
            PM_TRANS_NO='{$_POST['TID']}', PM_ORDER_NO='{$_POST['OID']}', PM_PAY_AMOUNT='{$_POST['amount']}',
            PM_APPROVAL_DATE='".date('Ymd')."', PM_APPROVAL_TIME='".date('His')."', PM_BANK_CODE='' , PM_PAYMENT_TYPE='1' , 
            PM_PG_NAME='SMARTRO' , PM_CARD_ISSUE_NAME='{$_POST['BankName']}', PM_ACQUIRER_CODE='{$_POST['BankCode']}', PM_BANK_NAME='{$_POST['BankName']}', 
            PM_ACCOUNT_NO='', PM_DEPOSIT_NAME='{$_POST['BuyerName']}', PM_EXPIRE_DATE='',  PM_REGIST_DATE='".G5_TIME_YMDHIS."', PM_REGIST_ID='{$_POST['BuyerName']}',
			pc_mobile='{$_POST['pc_mobile']}'
			 ";
 //echo "<br>$sql";exit;
 if($_POST['tpay']=='free') sql_query($sql);
 //}
?>
<body>
    <div id="wrap">
        <div class="fin">
            <div class="sbcenter">
                <div class="sb_content ">
                    <div class="sb_top_text sbclear">
                        <h3>재발급 신청 완료</h3>
                        <p>자격증 재발급이 신청되었습니다.</p>
                    </div>
                    <!--/sb_top_text-->
					<div class="click_btn">
                        <input type="button" value="닫기" onclick="window.close();">
                    </div>
                </div>
                <!--/sb_content-->
            </div>
            <!-- //sbcenter -->
        </div>
        <!-- //sbcenter -->
</body>

</html>
<script>
function noEvent() {
 if (event.keyCode == 116) {
  event.keyCode= 2;
  return false;
 }
 else if(event.ctrlKey && (event.keyCode==78 || event.keyCode == 82)){
	return false;
 }
}
document.oncontextmenu=function(){return false;}
document.onkeydown = noEvent;
</script>