<?
	// 응시자 명단을 엑셀로 추출 (검정번호를 입력하면 해당 검정번호의 응시자를 엑셀로 출력함.)

	include "./PHPExcel-1.8/Classes/PHPExcel.php";

	$Test_No = $_GET['No'];
	$ID = $_GET['ID'];
	
	if ($ID == 1){$ID = 'T1';}
	if ($ID == 4){$ID = 'SBT1';}

	$servername	= "dbserver"; $username = "skiresort"; $password = "ll170505"; $dbname = "skiresort";
	$connect = mysql_connect($servername, $username, $password); $link = mysqli_connect($servername, $username, $password, $dbname); mysql_select_db($dbname,$connect);

	// $query	= "SELECT * FROM 7G_Master_Apply where Test_No = '$Test_No' ORDER BY Apply_No" ;
 	$query= "select * from 7G_Master_Apply LEFT OUTER JOIN 7G_Skiresort_Member on 7G_Master_Apply.MEMBER_ID = 7G_Skiresort_Member.MEMBER_ID where 7G_Master_Apply.Test_No = '$Test_No' and 7G_Master_Apply.TEST_ID = '$ID' and 7G_Master_Apply.TRAN_STATUS = 1 ORDER BY Apply_No";
	$result	= mysqli_query($link, $query);
	$row 	= mysqli_fetch_array($result);

	$objPHPExcel = new PHPExcel();
	$today 		= date("Y-m-d");
	$file_name  = "티칭1_응시자명단($today)";
	
	// 헤더부분 색상지정 ---> HEX 값 지정
	$objPHPExcel -> getActiveSheet() -> getStyle("B4:K5") -> getFill() -> setFillType(PHPExcel_Style_Fill::FILL_SOLID) -> getStartColor() -> setRGB("9e9e9e");
	$objPHPExcel -> getActiveSheet() -> getStyle("B2:K5") -> getAlignment() -> setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_CENTER);
	$objPHPExcel -> getActiveSheet() -> getStyle("B2:K5") -> getAlignment() -> setVertical(PHPExcel_Style_Alignment::VERTICAL_CENTER);
	$objPHPExcel -> getActiveSheet() -> getStyle('B3')->getAlignment() -> setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_LEFT);

	$objPHPExcel->getActiveSheet()->getStyle('B4:K5')->getBorders()->getVertical()->setBorderStyle(PHPExcel_Style_Border::BORDER_THIN);
	$objPHPExcel->getActiveSheet()->getStyle('B4:K5')->getBorders()->getHorizontal()->setBorderStyle(PHPExcel_Style_Border::BORDER_THIN);

	// 셀머지
	$objPHPExcel -> getActiveSheet(0) -> mergeCells('B2:K2');
	$objPHPExcel -> getActiveSheet(0) -> mergeCells('B3:K3');
	$objPHPExcel -> getActiveSheet(0) -> mergeCells('B4:B5');
	$objPHPExcel -> getActiveSheet(0) -> mergeCells('C4:C5');
	$objPHPExcel -> getActiveSheet(0) -> mergeCells('D4:D5');
	$objPHPExcel -> getActiveSheet(0) -> mergeCells('E4:J4');
	$objPHPExcel -> getActiveSheet(0) -> mergeCells('K4:K5');


	$objPHPExcel -> setActiveSheetIndex(0) -> setCellValue(B2, "스키지도요원(TeachingⅠ) 채점");
	$objPHPExcel -> setActiveSheetIndex(0) -> setCellValue(B3, " $today");
	$objPHPExcel -> setActiveSheetIndex(0) -> setCellValue(E4, "실기시험");

	$objPHPExcel -> setActiveSheetIndex(0)
		-> setCellValue(B4, "구분")
		-> setCellValue(C4, "BIB")
		-> setCellValue(D4, "성명")
		-> setCellValue(E5, "페러렐 롱턴")
		-> setCellValue(F5, "페러렐 숏턴")
		-> setCellValue(G5, "슈템(중반부)")
		-> setCellValue(H5, "프르그보겐")
		-> setCellValue(I5, "총점")
		-> setCellValue(J5, "평균")
		-> setCellValue(K4, "비고");

	$count = 6;
	$i = 1;
	while($row) {
		$objPHPExcel -> setActiveSheetIndex(0)
			-> setCellValue("B".$count, "$i")
			-> setCellValue("D".$count, "$row[MEMBER_NAME] ($row[PHONE])");
			
		$count++;
		$i++;
		$row 	= mysqli_fetch_array($result);
	}

	// 가로 넓이 조정
		$objPHPExcel -> getActiveSheet() -> getColumnDimension("A") -> setWidth(2);
		$objPHPExcel -> getActiveSheet() -> getColumnDimension("B") -> setWidth(7);
		$objPHPExcel -> getActiveSheet() -> getColumnDimension("C") -> setWidth(7);
		$objPHPExcel -> getActiveSheet() -> getColumnDimension("D") -> setWidth(40);
		$objPHPExcel -> getActiveSheet() -> getColumnDimension("E") -> setWidth(15);
		$objPHPExcel -> getActiveSheet() -> getColumnDimension("F") -> setWidth(15);
		$objPHPExcel -> getActiveSheet() -> getColumnDimension("G") -> setWidth(15);
		$objPHPExcel -> getActiveSheet() -> getColumnDimension("H") -> setWidth(15);
		$objPHPExcel -> getActiveSheet() -> getColumnDimension("I") -> setWidth(15);
		$objPHPExcel -> getActiveSheet() -> getColumnDimension("J") -> setWidth(15);
		$objPHPExcel -> getActiveSheet() -> getColumnDimension("K") -> setWidth(15);
		
	// $objPHPExcel -> getActiveSheet() -> getColumnDimension(1) -> setRowHeight(1);

	// 가로 가운데 정렬
		$objPHPExcel -> getActiveSheet() -> getStyle("A6:K".$count) -> getAlignment() -> setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_CENTER);
		
	// 글자 크기 지정 (범위)
		$objPHPExcel -> getActiveSheet() -> getStyle("B3:K".$count) -> getFont(굴림) -> setSize(12);
		$objPHPExcel -> setActiveSheetIndex() -> getStyle('B2') -> getFont(굴림) -> setSize(24);

	// 전체 테두리 지정
		$objPHPExcel -> getActiveSheet() -> getStyle("A6:L".$count) -> getBorders() -> getAllBorders() -> setBorderStyle(PHPExcel_Style_Border::BORDER_THIN);
		$objPHPExcel -> getActiveSheet() -> getStyle("A6:K".$count) -> getBorders() -> getHorizontal() -> setBorderStyle(PHPExcel_Style_Border::BORDER_THIN);

	// 타이틀 부분
		$objPHPExcel -> getActiveSheet() -> getStyle("A1:E1") -> getFont() -> setBold(true);
		$objPHPExcel -> getActiveSheet() -> getStyle("A1:E1") -> getFill() -> setFillType(PHPExcel_Style_Fill::FILL_SOLID) -> getStartColor() -> setRGB("ffffff");

	// 내용부분 색상지정 --> White
		$objPHPExcel -> getActiveSheet() -> getStyle("A6:K".$count) -> getFill() -> setFillType(PHPExcel_Style_Fill::FILL_SOLID) -> getStartColor() -> setRGB("ffffff");

	//A1부터 F1까지의 셀의 세로 정렬 - 가운데 정렬
		$objPHPExcel -> getActiveSheet() -> getStyle("A1:E".$count) -> getAlignment () -> setVertical (PHPExcel_Style_Alignment::VERTICAL_CENTER);

	//셀 얇은 윤곽선
	// $objPHPExcel-> getActiveSheet()-> getStyle("A2:E".$count) -> getBorders() -> getAllBorders() -> setBorderStyle(PHPExcel_Style_Border::BORDER_THIN);

	// 시트 네임
		$objPHPExcel -> getActiveSheet() -> setTitle("T1 응시자명단");

	// 첫번째 시트(Sheet)로 열리게 설정
		$objPHPExcel -> setActiveSheetIndex(0);

	// 파일의 저장형식이 utf-8일 경우 한글파일 이름은 깨지므로 euc-kr로 변환해준다.
		$filename = iconv("UTF-8", "EUC-KR", "$file_name");

	// 브라우저로 엑셀파일을 리다이렉션
		header("Content-Type:application/vnd.ms-excel");
		header("Content-Disposition: attachment;filename=".$filename.".xls");
		header("Cache-Control:max-age=0");

		$objWriter = PHPExcel_IOFactory::createWriter($objPHPExcel, "Excel5");
		$objWriter -> save("php://output");
?>
