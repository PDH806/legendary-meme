<?
	// 응시자 명단을 엑셀로 추출 (검정번호를 입력하면 해당 검정번호의 응시자를 엑셀로 출력함.)

	include "./PHPExcel-1.8/Classes/PHPExcel.php";

	$Test_No = $_GET['No'];

	$servername	= "dbserver"; $username = "skiresort"; $password = "ll170505"; $dbname = "skiresort";
	$connect = mysql_connect($servername, $username, $password); $link = mysqli_connect($servername, $username, $password, $dbname); mysql_select_db($dbname,$connect);

	// $query	= "SELECT * FROM 7G_Master_Apply where Test_No = '$Test_No' ORDER BY Apply_No" ;
 	$query= "select * from 7G_Master_Apply LEFT OUTER JOIN 7G_Skiresort_Member on 7G_Master_Apply.MEMBER_ID = 7G_Skiresort_Member.MEMBER_ID where 7G_Master_Apply.Test_No = '$Test_No' and 7G_Master_Apply.TRAN_STATUS = 1 ORDER BY Apply_No limit 0, 50";
	$result	= mysqli_query($link, $query);
	$row 	= mysqli_fetch_array($result);

	$objPHPExcel = new PHPExcel();
	$today 		= date("Y-m-d");
	$file_name  = "티칭1_응시자명단";
	
	// 셀머지
	$objPHPExcel -> getActiveSheet(0) -> mergeCells('A1:E1');
	$objPHPExcel -> setActiveSheetIndex(0) -> setCellValue(A1, "T1 검정시험 응시자 명단 ($today)");

	$objPHPExcel -> setActiveSheetIndex(0)
		-> setCellValue(A2, "회원사진")
		-> setCellValue(B2, "응시번호")
		-> setCellValue(C2, "회원성명")
		-> setCellValue(D2, "전화번호")
		-> setCellValue(E2, "신청일");

	$count = 3;	
	while($row) {
		$objPHPExcel -> setActiveSheetIndex(0)
			-> setCellValue("B".$count, "$row[Apply_No]")
			-> setCellValue("C".$count, "$row[MEMBER_NAME]")
			-> setCellValue("D".$count, "$row[MEMBER_PHONE]")
			-> setCellValue("E".$count, "$row[Apply_date]");
			
			
		// 이미지 첨부하기
		$iCol = 'A'; // 컬럼번호
		$iRow = $count; // 행번호
				
				// 회원이미지 불러오기
				
				if ($row[PHOTO3]){$img_url = "../data/".$row[PHOTO3];}else{$img_url='../data/no_image.jpg';}

				$member_imgs_jpg = "../member_imgs/$row[MEMBER_ID]".".jpg";
				$member_imgs_jpeg = "../member_imgs/$row[MEMBER_ID]".".jpeg";
				$member_imgs_png = "../member_imgs/$row[MEMBER_ID]".".png";
				$member_imgs_gif = "../member_imgs/$row[MEMBER_ID]".".gif";

				if (is_file($member_imgs_jpg)){$img_url ="$member_imgs_jpg";}
				if (is_file($member_imgs_jpeg)){$img_url ="$member_imgs_jpeg";}
				if (is_file($member_imgs_png)){$img_url ="$member_imgs_png";}
				if (is_file($member_imgs_gif)){$img_url ="$member_imgs_gif";}

		

		$photo_path = "$img_url"; // 이미지 경로
		$objDrawing = new PHPExcel_Worksheet_Drawing();
		$objDrawing ->setName('Photo '.$iRow);
		$objDrawing ->setDescription('Photo '.$iRow);
		$objDrawing ->setPath($photo_path);
		$objDrawing ->setResizeProportional(true);
		$objDrawing ->setWidth(80);
		$objDrawing ->setOffsetX(12);
		$objDrawing ->setOffsetY(12);
		$objDrawing ->setCoordinates($iCol.$iRow);
		$objDrawing ->setWorksheet($objPHPExcel->getActiveSheet());
		$objPHPExcel ->getActiveSheet()->getRowDimension($iRow)->setRowHeight(100); // 행높이 설정

		$count++;
		$row 	= mysqli_fetch_array($result);
	}


	// 가로 넓이 조정
		$objPHPExcel -> getActiveSheet() -> getColumnDimension("A") -> setWidth(15);
		$objPHPExcel -> getActiveSheet() -> getColumnDimension("B") -> setWidth(10);
		$objPHPExcel -> getActiveSheet() -> getColumnDimension("C") -> setWidth(8);
		$objPHPExcel -> getActiveSheet() -> getColumnDimension("D") -> setWidth(8);
		$objPHPExcel -> getActiveSheet() -> getColumnDimension("E") -> setWidth(20);

	// 가로 가운데 정렬
		$objPHPExcel -> getActiveSheet() -> getStyle("A1:E".$count) -> getAlignment() -> setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_CENTER);
		
	// 글자 크기 지정 (범위)
		$objPHPExcel -> getActiveSheet() -> getStyle("A3:E".$count) -> getFont(굴림) -> setSize(12);
		$objPHPExcel -> setActiveSheetIndex(0) -> getStyle('A1') -> getFont(굴림) -> setSize(24);

	// 전체 테두리 지정
		$objPHPExcel -> getActiveSheet() -> getStyle("A2:F".$count) -> getBorders() -> getAllBorders() -> setBorderStyle(PHPExcel_Style_Border::BORDER_THIN);
		$objPHPExcel -> getActiveSheet() -> getStyle("A2:F".$count) -> getBorders() -> getHorizontal() -> setBorderStyle(PHPExcel_Style_Border::BORDER_THIN);


	// 타이틀 부분
		$objPHPExcel -> getActiveSheet() -> getStyle("A1:E1") -> getFont() -> setBold(true);
		$objPHPExcel -> getActiveSheet() -> getStyle("A1:E1") -> getFill() -> setFillType(PHPExcel_Style_Fill::FILL_SOLID) -> getStartColor() -> setRGB("ffffff");
	// $objPHPExcel -> getActiveSheet() -> getRowDimension(1) -> setRowHeight(23);

	// 헤더부분 색상지정 ---> HEX 값 지정
		$objPHPExcel -> getActiveSheet() -> getStyle("A2:E2") -> getFill() -> setFillType(PHPExcel_Style_Fill::FILL_SOLID) -> getStartColor() -> setRGB("91edff");


	// 내용부분 색상지정 --> White
		$objPHPExcel -> getActiveSheet() -> getStyle("A3:E".$count) -> getFill() -> setFillType(PHPExcel_Style_Fill::FILL_SOLID) -> getStartColor() -> setRGB("ffffff");

	//A1부터 F1까지의 셀의 세로 정렬 - 가운데 정렬
		$objPHPExcel -> getActiveSheet() -> getStyle("A1:E".$count) -> getAlignment () -> setVertical (PHPExcel_Style_Alignment::VERTICAL_CENTER);


	//셀 얇은 윤곽선
	// $objPHPExcel-> getActiveSheet()-> getStyle("A2:E".$count) -> getBorders() -> getAllBorders() -> setBorderStyle(PHPExcel_Style_Border::BORDER_THIN);


	// 시트 네임
		$objPHPExcel -> getActiveSheet() -> setTitle("T1 응시자명단");

	// 첫번째 시트(Sheet)로 열리게 설정
		$objPHPExcel -> setActiveSheetIndex(0);

	// 파일의 저장형식이 utf-8일 경우 한글파일 이름은 깨지므로 euc-kr로 변환해준다.
		$filename = iconv("UTF-8", "EUC-KR", "$file_name");

	// 브라우저로 엑셀파일을 리다이렉션
		header("Content-Type:application/vnd.ms-excel");
		header("Content-Disposition: attachment;filename=".$filename.".xls");
		header("Cache-Control:max-age=0");

		$objWriter = PHPExcel_IOFactory::createWriter($objPHPExcel, "Excel5");
		$objWriter -> save("php://output");
?>
