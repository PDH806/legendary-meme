<?php
    header('Content-Type: text/html; charset=utf-8');
	   $READY_API_URL = "../pc/T3_exam_ready.php";

	   // 변수값 넘거받기
	   include '../db_config.html';
		if (!$Login_User_ID){echo " <script language='javascript'>alert('로그인이 필요한 서비스 입니다.');top.document.location.href = 'member_login.html?case=9'</script>";}

	   extract($_REQUEST);
	   $Date = date('Ymd');
	   $Test_No = $No;

	   if ($type == 'T1'){$Test_Name = '스키 티칭1'; $Test_Table = '7G_T1_Schedules'; $Apply_Table = '7G_T1_Apply'; $Product_Name = 'SKI-Teaching1'; $REF_NO = "TA";}
	   if ($type == 'T2'){$Test_Name = '스키 티칭2'; $Test_Table = '7G_T2_Schedules'; $Apply_Table = '7G_T2_Apply'; $Product_Name = 'SKI-Teaching2'; $REF_NO = "TB";}
	   if ($type == 'T3'){$Test_Name = '스키 티칭3 & 기술선수권대회'; $Test_Table = '7G_T3_Schedules'; $Apply_Table = '7G_T3_Apply'; $Product_Name = 'SKI-Teaching3'; $REF_NO = "TC";}

	   if ($type == 'SBT1'){$Test_Name = '스노보드 티칭1'; $Test_Table = '7G_SBT1_Schedules'; $Apply_Table = '7G_SBT1_Apply'; $Product_Name = 'SB-Teaching1'; $REF_NO = "SA";}
	   if ($type == 'SBT2'){$Test_Name = '스노보드 티칭2'; $Test_Table = '7G_SBT2_Schedules'; $Apply_Table = '7G_SBT2_Apply';  $Product_Name = 'SB-Teaching2'; $REF_NO = "SB";}
	   if ($type == 'SBT3'){$Test_Name = '스노보드 티칭3 & 기술선수권대회'; $Test_Table = '7G_SBT3_Schedules'; $Apply_Table = '7G_SBT3_Apply';  $Product_Name = 'SB-Teaching3'; $REF_NO = "SC";}

	   if ($type == 'PATROL'){$Test_Name = '스키구조요원'; $Test_Table = '7G_Patrol_Schedules'; $Apply_Table = '7G_Patrol_Apply';  $Product_Name = 'PATROL'; $REF_NO = "P";}

	   // 신청테이블에 이번 신청내용이 등록되어 있는지 체크
	   $dup_query	= "SELECT * FROM 7G_Master_Apply where Test_id = '$type' and TEST_NO = '$No' and MEMBER_ID = '$Login_User_ID' and PAYMENT_STATUS = 2";
	   $dup_result	= mysql_query($dup_query,$connect);
	   $dup_check	= mysql_fetch_array($dup_result);
	   $dup_total_record = mysql_num_rows($dup_result);

    	// 검정일정 불러오기 (건별)
   	   $query1		= "SELECT * FROM 7G_Master_Schedules where Test_id = '$type' and TEST_NO = '$No'";
	   $result1	= mysql_query($query1,$connect);
	   $row1		= mysql_fetch_array($result1);

    // 회원정보 불러오기
	   $query		= "SELECT * FROM 7G_Skiresort_Member where MEMBER_ID = '$Login_User_ID'";
	   $result		= mysql_query($query,$connect );
	   $member		= mysql_fetch_array($result);

    // 거래번호 생성을 위한 기존 거래내역 총 건수 조회
	   $query		= "SELECT * FROM 7G_Master_Apply where MEMBER_ID = '$Login_User_ID'";
	   $result		= mysqli_query($link, $query);
	   $count		= mysqli_num_rows($result) + 1;
	   $length 	= strlen($count);
	   if($length == 1){$count = "00".$count;}
	   if($length == 2){$count = "0".$count;}
	   if($length == 3){$count = $count;}

	   $REF_NO = "TC-";
	   $mbrRefNo = $REF_NO.$member['NO'].'-'.$count;

	   // SPC PG의 결제가 (또는 결제창이 클로즈) 완료 또는 실패했을때 처리하는 스크립트 (매우 중요)
	   echo "<script>function mainpay_close_event(){top.document.location.href = '../mypage/admin_master_apply_list.html';}</script>";

?>

<!DOCTYPE html>

<html lang="ko">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>2022년 스키기선전 및 티칭3 선발신청</title>
    <!-- Favicon icon -->
    <link rel="icon" type="image/png" sizes="16x16" href="./images/favicon.png">
	<link href="./vendor/bootstrap-select/dist/css/bootstrap-select.min.css" rel="stylesheet">
    <link href="./css/style.css" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@100;200;300;400;500;600;700;800;900&family=Roboto:wght@100;300;400;500;700;900&display=swap" rel="stylesheet">
    <style>.form-control{border-radius: $radius; background: $white; border: 1px solid $border; font-size:13pt; color: #f54242; height: 60px; @include respond('laptop') { height: 41px; } &:hover,&:focus,&.active{ box-shadow: none; background: $white; color: $dark; } }</style>
    <script src="https://api-std.mainpay.co.kr/js/mainpay.pc-1.1.js"></script>
    


	<script type='text/javascript'>
	var READY_API_URL = "<?=$READY_API_URL?>";

    var doubleSubmitFlag = false;
    	
    function doubleSubmitCheck(){
        if(doubleSubmitFlag){
            return doubleSubmitFlag;
        	}else{
            doubleSubmitFlag = true;
            return false;
        	}
    	}

	function payment() {

  		var reg_email = /^([0-9a-zA-Z_\.-]+)@([0-9a-zA-Z_-]+)(\.[0-9a-zA-Z_-]+){1,2}$/;
		var eMail = document.getElementById("BuyerEmail").value;
        var BIRTH = document.getElementById("BIRTH").value;
        var Participate = document.getElementById("Participate").value;
		var GENDER2 = document.getElementById("GENDER2").value;
        var VACCINE  = document.getElementById("VACCINE").value;
        var check1_stat = document.getElementById('applycheck').checked;
        var License_No  = document.getElementById("License_No").value;

        var photo1 = document.getElementById("photo1").value;
        var photo2 = document.getElementById("photo2").value;


		if (GENDER2 === '0'){alert('성별을 입력해 주세요 !!!');return;}
		if (BIRTH === ''){alert('생년월일을 등록해 주세요 !!!');return}
		if (License_No === ''){alert('티칭 또는 레벨자격 번호를 입력해 주세요 !!!');return;}
  	    if (VACCINE === ''){alert('백신접종여부를 입력해 주세요 !!!');return;}


		if (check1_stat !== true ){alert('참가규정 및 유의사항을 확인 및 동의해 주시기 바랍니다!!!'+check1_stat);return;}
		if(Participate >= 100 && (VACCINE == '0' || VACCINE == '')){ alert('백신접종여부를 입력해 주세요 !!!'); return; }

        if(photo1 == 'None' && !photo2){ alert('증명사진(필수)을 등록해 주세요 !!!'); return; }

   	 	if(doubleSubmitCheck()) return;

		var request = Mainpay.ready(READY_API_URL);
		request.done(function(response) {
			if (response.resultCode == '200') {
				/* 결제창 호출 */
				Mainpay.open(response.data.nextPcUrl); //*주의* PC와 Mobile은 URL이 상이합니다.
				return false;
			}
			alert("ERROR : "+JSON.stringify(response));
		});
	}
	
	window.onpopstate = function(){ history.go(-1)};

	function go_back(){top.document.location.href = '$return_page'}

</script>

	<?

  // 성별코드를 실제설별로 환원
	if ($member[GENDER] == 1){$selected1_1 = 'selected';}
	if ($member[GENDER] == 2){$selected1_2 = 'selected';}


	$test_date = $row1[Test_Date]." ($row1[Time])";

	$Product_Name = $Product_Name." ($member[MEMBER_NAME]님-".$member[NO].")";

	if ($dup_check[Apply_date] == ''){$dup_check[Apply_date] = $today;}

	$buyerName        = $member[MEMBER_NAME];	// 구매자명
	$buyerTel         = $member[PHONE];			// 구매자연락처
	$buyerEmail       = $member[EMAIL];			// 구매자메일주소
?>

</head>

<body>

    <!--*******************
        Preloader start
    ********************-->
    <div id="preloader">
        <div class="sk-three-bounce">
            <div class="sk-child sk-bounce1"></div>
            <div class="sk-child sk-bounce2"></div>
            <div class="sk-child sk-bounce3"></div>
        </div>
    </div>
    <!--*******************
        Preloader end
    ********************-->


    <!--**********************************
        Main wrapper start
    ***********************************-->
    <div id="main-wrapper">

        <!--**********************************
            Nav header start
        ***********************************-->
        <div class="nav-header">
            <a href="../index.html" class="brand-logo">
                <img src="../images/sb_logo.png" width = 90%>
            </a>

            <div class="nav-control">
                <div class="hamburger">
                    <span class="line"></span><span class="line"></span><span class="line"></span>
                </div>
            </div>
        </div>
        <!--**********************************
            Nav header end
        ***********************************-->

		<?
		// 챗팅박스 + 헤드네비 불러오기
		include '_chat_box.html';
		//include '_head_bar.html';

		// 좌측 네비게이션
    	include '_my_menu.html';
    ?>


        <!--**********************************
            Content body start
        ***********************************-->
        <div class="content-body">
            <!-- container starts -->
            <div class="container-fluid">
                <!-- row -->


<?	echo "
    		<div class='container' style = 'padding:0px;'>
      			<div class='row'>
        			<div class='col-lg-12 text-center'>
          				<p class = 'font32'>$Test_Name 신청 및 응시료결제</p>
						<p class='font13' style = 'color:blue;font-weight:700;'>참가 규정 및 유의 사항을 확인하시고 규정 및 유의사항 준수를 동의하셔야만 참가신청이 가능합니다.</p>
          				<p class='font13' style = 'color:red;font-weight:500;'>신용카드 결제가 종료되어야 검정신청이 완료되며, 2022 진행됩니다.</p>						
        			</div>
      			</div>
      		</div>

		    <div class='container'>

		<form id='MAINPAY_FORM'>
		<input type='text' name='GoodsCnt' value='1' hidden>
		<input name='Test_No' type='text' value='$Test_No' hidden>
		<input name='type' type='text' value='$type' hidden>

                <br>
                <table style = 'height:60px;border-bottom:1px solid #888888;' width = 100% >
        		<tr><td class = 'font16' align = center style = 'background-color:#000000;color:#FFFFFF;width:220px;font-weight:700;'>응시자 정보</td><td></td></tr></table><br>


                <div class='form-group' >
						<div class='input-group'>
  							<div class='input-group-prepend'>
								<button class='btn btn-info border-dark' type='button' style = 'width:220px;'>성명</button>
  							</div>
								<input class='form-control'  type='text' name='BuyerName' value = '$member[MEMBER_NAME]' style = 'height:50px;' readonly>
								<input class='form-control'  type='text' name='MEMBER_ID' value = '$member[MEMBER_ID]' hidden>
								<input class='form-control'  type='text' name='MEMBER_NO' value = '$member[NO]' hidden>
								<input class='form-control'  type='text' name='Test_No' value = '$Test_No' hidden>
        						<input class='form-control'  type='text' name='Skiresort_No' value = '$row1[Skiresort]' hidden>
        						<input class='form-control'  type='text' id = 'Participate' name='Participate'  value = '$row1[Participate]' hidden>

						</div>
                </div>

                <div class='form-group'>
						<div class='input-group'>
  							<div class='input-group-prepend'>
								<button class='btn btn-info border-dark' type='button' style = 'width:220px;'>핸드폰</button>
  							</div>
								<input class='form-control'  type='text' name='BuyerTel' value = '$member[PHONE]' style = 'height:50px;' readonly>
						</div>
                </div>

                <div class='form-group' >
						<div class='input-group'>
  							<!--div class='input-group-prepend'>
								<button class='btn btn-info border-dark' type='button' style = 'width:220px;'>이메일</button>
  							</div-->
								<input class='form-control'  type='hidden' id = 'BuyerEmail' name='BuyerEmail' value = '' style = 'height:50px;' readonly>
						</div>
                </div>


                <div class='form-group' >
						<div class='input-group'>
  							<div class='input-group-prepend'>
								<button class='btn btn-info border-dark' type='button' style = 'width:220px;'>자격번호</button>
  							</div>
								<input class='form-control' type='text' id = 'License_No' name='License_No' value = '' style = 'height:50px;' >
						</div>
                </div>



                    <div class='form-group'>
              						<div class='input-group'>
                							<div class='input-group-prepend'>
              								        <button class='btn btn-info border-dark' type='button' style = 'width:220px;'>생년월일</button>
                							</div>
              								        <input class='form-control'  type='date' id = 'BIRTH' name='BIRTH' value = '$member[BIRTH]' style = 'height:60px;'>
              						</div>
                    </div>
                    

                <div class='form-group' >
              						<div class='input-group'>
                							<div class='input-group-prepend'>
              								<button class='btn btn-info border-dark' type='button' style = 'width:220px;'>성별</button>
                							</div>
                      						<select class='form-control' id = 'GENDER2' name = 'GENDER2' $style_info>
                        					<option value = '0'>성별</option>
        									<option value = '0'>-----------------------------------</option>
                        					<option value = '1' $selected1_1>남성</option>
                        					<option value = '2' $selected1_2>여성</option>
                      </select>
              		</div>
                </div>                 


                    <div class='form-group' >
              						<div class='input-group'>
                							<div class='input-group-prepend'>
              								<button class='btn btn-info border-dark' type='button' style = 'width:220px;'>백신접종</button>
                							</div>
                     	 <select class='form-control' id = 'VACCINE' name = 'VACCINE' $style_info>
                       		 	<option value = '0'>코로나19 백신접종여부</option>
                        		<option value = '0'>---------------------</option>
                        		<option value = '2'>2차접종완료</option>
                        		<option value = '3'>3차접종완료</option>
                      	</select>
                </div>		
            </div>


                <div class='form-group'>
						<div class='input-group'>
  							<div class='input-group-prepend'>
								<button class='btn btn-info border-dark' type='button' style = 'width:220px;'>신청일자</button>
  							</div>
								<input class='form-control'  type='text' name='Apply_date' value = '$dup_check[Apply_date]' style = 'height:50px;' readonly>
						</div>
                </div>

                <br><br>

                <table style = 'height:60px;border-bottom:1px solid #888888;' width = 100% >
        		<tr><td class = 'font16' align = center style = 'background-color:#000000;color:#FFFFFF;width:220px;font-weight:700;'>회원사진</td><td></td></tr></table><br>";

				if ($member[PHOTO3]){$img_url = "../data/$row[PHOTO3]"; $photo = 'YES';}
				if (!$member[PHOTO3]){$img_url = "../data/no_image.jpg"; $photo = 'YES';}
				if ($member[image]){$img_url = "../view3.html?id=$row[MEMBER_ID]"; $photo = 'YES';}

				$member_imgs_jpg = "../member_imgs/$member[MEMBER_ID]".".jpg";
				$member_imgs_jpeg = "../member_imgs/$member[MEMBER_ID]".".jpeg";
				$member_imgs_png = "../member_imgs/$member[MEMBER_ID]".".png";
				$member_imgs_gif = "../member_imgs/$member[MEMBER_ID]".".gif";

				if ($member[PHOTO3]){$img_url = "../data/".$member[PHOTO3];}else{$img_url='../data/no_image.jpg'; $photo = '';}

				if (is_file($member_imgs_jpg)){$img_url ="$member_imgs_jpg"; $photo = 'YES';}
				if (is_file($member_imgs_jpeg)){$img_url ="$member_imgs_jpeg"; $photo = 'YES';}
				if (is_file($member_imgs_png)){$img_url ="$member_imgs_png"; $photo = 'YES';}
				if (is_file($member_imgs_gif)){$img_url ="$member_imgs_gif"; $photo = 'YES';}


      			echo "<img src = '$img_url' width = 200px><br><br>
      				<input type ='text' id = 'photo' name = 'photo' value = '$photo' hidden>

      				 <div class='form-group' style='padding-left:10px'>
      						<div class='input-group'>
        							<div class='input-group-prepend'>
      								<button class='btn btn-info' type='button' style = 'width:220px;'>사진등록</button>
        							</div>
      								<input class='form-control' type='file' id = 'photo2' name='image' placeholder='이미지를 선택해 주세요 (6M Byte 이하)'>
                      <input class='form-control'  type='text' id = 'photo1' name='photo1' value = '$photo' hidden>
      						</div>
                </div>

				<br><br><br>
                <table style = 'height:60px;border-bottom:1px solid #888888;' width = 100% >
        		<tr><td class = 'font16' align = center style = 'background-color:#000000;color:#FFFFFF;width:220px;font-weight:700;'>검정 & 결제내용</td><td></td></tr></table><br>

                <div class='form-group' >
						<div class='input-group'>
  							<div class='input-group-prepend'>
								<button class='btn btn-info border-dark' type='button' style = 'width:220px;'>결제수단</button>
  							</div>
								<select class='form-control' id = 'Payment_Method' name = 'paymethod' style = 'height:50px;'>
									<option>응시료결제방법</option>
									<option>-----------------------------------</option>
									<option value = 'CARD' selected>신용카드</option>
        						</select>
						</div>
      </div>";

				echo "
                <div class='form-group' >
						<div class='input-group'>
  							<div class='input-group-prepend'>
								<button class='btn btn-info border-dark' type='button' style = 'width:220px;'>응시항목</button>
  							</div>";
  							
  							?>
								<select class='form-control' onchange="document.getElementById('Amt').value = this.options[this.selectedIndex].value" id = 'goodsName' name = 'goodsName' style = 'height:50px;'>
									<option>응시료결제방법</option>
									<option>-----------------------------------</option>
									<option value = '100000' selected>기선전만출전(10만원)</option>
									<option value = '120000'>티칭3만출전(12만원)</option>
									<option value = '175000'>기선전&티칭3출전(175천원)</option>
        						</select>
						</div>
				</div>
				
				
				<?
				
				echo "
                <div class='form-group'>
						<div class='input-group'>
  							<div class='input-group-prepend'>
								<button class='btn btn-info border-dark' type='button' style = 'width:220px;'>응시료/결제금액</button>
  							</div>
								<input class='form-control'  type='text' id = 'Amt' name='Amt' value = '100000' style = 'height:50px;' readonly>
						</div>
                </div>


                <div class='form-group'>
						<div class='input-group'>
  							<div class='input-group-prepend'>
								<button class='btn btn-info border-dark' type='button' style = 'width:220px;'>접수번호</button>
  							</div>
								<input class='form-control'  type='text' id = 'REF_NO' name='REF_NO' value = '$mbrRefNo' style = 'height:50px;' readonly>
						</div>
                </div>
				
                <table style = 'height:60px;border-bottom:1px solid #888888;' width = 100% >
        		<tr><td class = 'font16' align = center style = 'background-color:#000000;color:#FFFFFF;width:280px;font-weight:700;'>참가규정 및 유의사항</td>
				<td><a href = '../hwp/2022_T2.pdf' download='file.pdf' >&nbsp;&nbsp;<p class='font16' style = 'color:red;font-weight:900;'>&nbsp;&nbsp;참가규정 및 유의사항 다운로드 [Click Here]</p></a></td></tr></table><br>
                <div class='form-group' >
						<div class='input-group'>
						※ 참가 규정 및 유의 사항(홈페이지 공지사항 게시) 을 확인하였으며 규정 및 유의사항 준수를 동의합니다. &nbsp;&nbsp; <input type='checkbox' id = 'applycheck' name= 'applycheck' value='1' checked>
						</div>
                </div>

			";

?>


				</form>
			</div>
		</div><br>



	<div class='container text-center' style = 'padding:0px;'>
		<!--button class='btn-blue' style = 'height:80px;width:100px;' onclick='go_back()';>이전 페이지</button-->


		<?

		if ($type == 'T1' or $type == 'SBT1')
			{
				if($dup_check[Process] == '0' or $dup_check[Process] == ''  )
					{echo"&nbsp;<button class='btn-black' style = 'height:80px;width:100px;' onclick='payment2()';>$type 시험신청</button>";}
				else
					{echo"&nbsp;<button class='btn-black' style = 'height:80px;width:100px;' onclick='payment2()';>완료</button>";}


			}

		if ($type == 'T2' or $type == 'T3' or $type == 'SBT2' or $type == 'SBT3' or $type == 'PATROL' )
			{

				echo "&nbsp;<button class='btn-blue' style = 'height:100px;width:300px;' onclick='payment()';>검정료결제</button>";
				//if ($dup_total_record > 0){echo "&nbsp;<button class='btn-red' style = 'height:100px;width:300px;'>신청완료(신청불가)</button>";}


			}

?>

	</div></div><br>

<?

if ($process == '1' and $type != 'SBT1' and $type != 'T1'){echo "<script>alert('응시로 결제를 위해 신청하신 내용을 다시 한번 확인해 주십시오.')</script>";}

	include 'footer.html';

?>

</div>
<br><br><br>


                <!-- Row ends -->
            </div>
            <!-- container ends -->
        </div>
        <!--**********************************
                Content body end
            ***********************************-->


        <!--**********************************
            Footer start
        ***********************************-->
        <div class="footer">
            <div class="copyright">
                <p>© Designed &amp; Developed by <a href="https://7gate.kr/" target="_blank">podong28.com</a> 2019</p>
            </div>
        </div>
        <!--**********************************
            Footer end
        ***********************************-->


    </div>
    <!--**********************************
        Main wrapper end
    ***********************************-->

    <!--**********************************
        Scripts
    ***********************************-->
    <!-- Required vendors -->
    <script src="./vendor/global/global.min.js"></script>
	<script src="./vendor/bootstrap-select/dist/js/bootstrap-select.min.js"></script>
    <script src="./js/custom.min.js"></script>
	<script src="./js/deznav-init.js"></script>

<script>
$(document).ready(function(){
 $(document).on('change', '#file', function(){
  var name = document.getElementById("file").files[0].name;
  var form_data = new FormData();
  var ext = name.split('.').pop().toLowerCase();
  if(jQuery.inArray(ext, ['gif','png','jpg','jpeg']) == -1) 
  {
   alert("Invalid Image File");
  }
  var oFReader = new FileReader();
  oFReader.readAsDataURL(document.getElementById("file").files[0]);
  var f = document.getElementById("file").files[0];
  var fsize = f.size||f.fileSize;
  if(fsize > 2000000)
  {
   alert("Image File Size is very big");
  }
  else
  {
   form_data.append("file", document.getElementById('file').files[0]);
   $.ajax({
    url:"_documents_upload.php",
    method:"POST",
    data: form_data,
    contentType: false,
    cache: false,
    processData: false,
    beforeSend:function(){
     $('#uploaded_image').html("<label class='text-success'>Image Uploading...</label>");
    },   
    success:function(data)
    {
     $('#uploaded_image').html(data);
    }
   });
  }
 });
});
</script>



</body>

</html>