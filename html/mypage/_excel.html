<?
	// PHP에서 엑셀 다운받은 샘플 프로그램

	include "./PHPExcel-1.8/Classes/PHPExcel.php";

	$servername	= "localhost"; $username = "skiresort"; $password = "ll170505"; $dbname = "skiresort";
	$connect = mysql_connect($servername, $username, $password); $link = mysqli_connect($servername, $username, $password, $dbname); mysql_select_db($dbname,$connect);

	$query	= "SELECT * FROM 7G_Skiresort_Member ORDER BY NO limit 100" ;
	$result	= mysqli_query($link, $query);
	$row 	= mysqli_fetch_array($result);

	$objPHPExcel = new PHPExcel();
	$today 		= date("Y-m-d");
	$file_name  = "PHP엑셀테스트";
	
	// 셀머지
	$objPHPExcel->getActiveSheet(0)->mergeCells('A1:D1');
	$objPHPExcel -> setActiveSheetIndex(0) -> setCellValue(A1, "$today");

	$objPHPExcel -> setActiveSheetIndex(0)
		-> setCellValue(A2, "회원ID")
		-> setCellValue(B2, "회원성명")
		-> setCellValue(C2, "전화")
		-> setCellValue(D2, "생년월일");

	$count = 3;	
	while($row) {
		$objPHPExcel -> setActiveSheetIndex(0)
			-> setCellValue("A".$count, "$row[NO]")
			-> setCellValue("B".$count, "$row[MEMBER_ID]")
			-> setCellValue("C".$count, "$row[MEMBER_NAME]")
			-> setCellValue("D".$count, "$row[PHONE]");
		$count++;
		$row 	= mysqli_fetch_array($result);
	}



	// 이미지 첨부하기
		$iCol = 'G'; // 컬럼번호
		$iRow = 1; // 행번호

		$photo_path = "sample.jpg"; // 이미지 경로
		$objDrawing = new PHPExcel_Worksheet_Drawing();
		$objDrawing->setName('Photo '.$iRow);
		$objDrawing->setDescription('Photo '.$iRow);
		$objDrawing->setPath($photo_path);
		$objDrawing->setResizeProportional(true);
		$objDrawing->setWidth(80);
		$objDrawing->setOffsetX(12);
		$objDrawing->setOffsetY(12);
		$objDrawing->setCoordinates($iCol.$iRow);
		$objDrawing->setWorksheet($objPHPExcel->getActiveSheet());
		$objPHPExcel->getActiveSheet()->getRowDimension($iRow)->setRowHeight(100); // 행높이 설정

	// 가로 넓이 조정
		$objPHPExcel -> getActiveSheet() -> getColumnDimension("A") -> setWidth(10);
		$objPHPExcel -> getActiveSheet() -> getColumnDimension("B") -> setWidth(12);
		$objPHPExcel -> getActiveSheet() -> getColumnDimension("C") -> setWidth(30);
		$objPHPExcel -> getActiveSheet() -> getColumnDimension("D") -> setWidth(15);

	// 전체 가운데 정렬
		$objPHPExcel -> getActiveSheet() -> getStyle("A1:D".$count) -> getAlignment() -> setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_CENTER);
		
	// 글자 크기 지정 (범위)
		$objPHPExcel -> getActiveSheet() -> getStyle("A3:D".$count) -> getFont(굴림)->setSize(12);
		$objPHPExcel->setActiveSheetIndex(0)->getStyle('A1')->getFont(굴림)->setSize(24);

	// 전체 테두리 지정
		$objPHPExcel -> getActiveSheet() -> getStyle("A1:D".$count) -> getBorders() -> getAllBorders() -> setBorderStyle(PHPExcel_Style_Border::BORDER_THIN);

	// 타이틀 부분
		$objPHPExcel -> getActiveSheet() -> getStyle("A1:D1") -> getFont() -> setBold(true);
		$objPHPExcel -> getActiveSheet() -> getStyle("A1:D1") -> getFill() -> setFillType(PHPExcel_Style_Fill::FILL_SOLID) -> getStartColor() -> setRGB("CECBCA");
	// $objPHPExcel -> getActiveSheet() -> getRowDimension(1) -> setRowHeight(23);

	// 내용 지정
		$objPHPExcel -> getActiveSheet() -> getStyle("A1:D".$count) -> getFill() -> setFillType(PHPExcel_Style_Fill::FILL_SOLID) -> getStartColor() -> setRGB("F4F4F4");

	// 시트 네임
		$objPHPExcel -> getActiveSheet() -> setTitle("회원명단");

	// 첫번째 시트(Sheet)로 열리게 설정
		$objPHPExcel -> setActiveSheetIndex(0);

	// 파일의 저장형식이 utf-8일 경우 한글파일 이름은 깨지므로 euc-kr로 변환해준다.
		$filename = iconv("UTF-8", "EUC-KR", "$file_name");

	// 브라우저로 엑셀파일을 리다이렉션
		header("Content-Type:application/vnd.ms-excel");
		header("Content-Disposition: attachment;filename=".$filename.".xls");
		header("Cache-Control:max-age=0");

		$objWriter = PHPExcel_IOFactory::createWriter($objPHPExcel, "Excel5");
		$objWriter -> save("php://output");
?>
