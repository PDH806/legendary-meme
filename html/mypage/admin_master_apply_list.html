<?
	$The_No 	= $_GET["No"];
	$month 		= $_GET["month"];
	$history	= $_GET["history"];
	$ID			= $_GET['ID'];
	$token		= $_GET['token'];

	$main_title = '한국 스키장 경영협회';
	$Dashboard_Title = 'My Page > 검정 및 시험 응시현황';
	if ($history == 1){$Dashboard_Title = 'My Page > 검정 및 시험 응시현황 (검정완료)';}
	include '../db_config.html';

	header('Content-Type: text/html; charset=utf-8');
	$READY_API_URL = "../pc/exam_ready_cancel.php";


	// 관리자가 아니면 member_login.html 페이지로 이동
	if (!$Login_User_ID){
	echo " <script>
	alert('비정상적인 접근입니다.');
	top.document.location.href = '../member_login.html';
	</script>";
	}

	//if (!$token){
	//echo " <script>
	//alert('잘못된 접근 (인증값 오류) 입니다. ');
	//top.document.location.href = '../member_login.html?MEMBER_ID=$User_ID_Search&Case=9';
	//</script>";
	//}

?>

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Admin Dashboard | (사)한국스키장경영협회</title>
    <!-- Favicon icon -->
    <link rel="icon" type="image/png" sizes="16x16" href="../images/favicon.ico">
	   <link rel="stylesheet" href="./vendor/chartist/css/chartist.min.css">
    <link href="./vendor/bootstrap-select/dist/css/bootstrap-select.min.css" rel="stylesheet">
	<!-- Datatable -->
    <link href="./vendor/datatables/css/jquery.dataTables.min.css" rel="stylesheet">
    <link href="./css/style.css" rel="stylesheet">
	   <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@100;200;300;400;500;600;700;800;900&family=Roboto:wght@100;300;400;500;700;900&display=swap" rel="stylesheet">

<?
  // 회원정보 불러오기
	 $query		= "SELECT * FROM 7G_Skiresort_Member where MEMBER_ID = '$Login_User_ID'";
	 $result		= mysqli_query($link, $query);
	 $member		= mysqli_fetch_array($result);
	 
	$query2= "SELECT * FROM 7G_Skiresort_Member where MEMBER_ID = '$Login_User_ID'" ;
	$result2=mysqli_query($link, $query2);
	$login_member=mysqli_fetch_array($result2);


		$search = "where ((TEST_ID <> 'T1' or TEST_ID <> 'SBT1') and  PAYMENT_STATUS >= 2 and 7G_Master_Apply.MEMBER_ID = '$Login_User_ID') or ((TEST_ID = 'T1' or TEST_ID = 'SBT1') and  TRAN_STATUS >= 1 and 7G_Master_Apply.MEMBER_ID = '$Login_User_ID') ";
		if ($history == 1){$search = "where 7G_Master_Apply.MEMBER_ID = '$Login_User_ID' and 7G_Master_Apply.Apply_date <= '2021.01.01'";}

	//loop
 	$query= "select * from 7G_Master_Apply LEFT OUTER JOIN 7G_Skiresort_Member on 7G_Master_Apply.MEMBER_ID = 7G_Skiresort_Member.MEMBER_ID $search order by 7G_Master_Apply.Apply_No desc";
    //echo $query;
 	$result=mysql_query($query,$connect );
 	$row=mysql_fetch_array($result);
		$total_record = mysql_num_rows($result);

 	$query1= "select * from 7G_Master_Apply where No = '$The_No'";
 	$result1=mysql_query($query1,$connect );
 	$row1=mysql_fetch_array($result1);
		$total_record = mysql_num_rows($result);

		if ($row1[Skiresort] == 1){$Skiresort = '용평리조트';}
		if ($row1[Skiresort] == 2){$Skiresort = '양지파인리조트';}
		if ($row1[Skiresort] == 3){$Skiresort = '스타힐리조트';}
		if ($row1[Skiresort] == 4){$Skiresort = '무주덕유산리조트';}
		if ($row1[Skiresort] == 5){$Skiresort = '비발디파크';}
		if ($row1[Skiresort] == 6){$Skiresort = '휘닉스파크';}
		if ($row1[Skiresort] == 7){$Skiresort = '웰리힐리파크';}
		if ($row1[Skiresort] == 8){$Skiresort = '지산포레스트리조트';}
		if ($row1[Skiresort] == 9){$Skiresort = '엘리시안강촌';}
		if ($row1[Skiresort] == 10){$Skiresort = '오크밸리';}
		if ($row1[Skiresort] == 11){$Skiresort = '하이원리조트';}
		if ($row1[Skiresort] == 12){$Skiresort = '곤지암리조트';}
		if ($row1[Skiresort] == 13){$Skiresort = '알펜시아';}
		if ($row1[Skiresort] == 14){$Skiresort = '베어스타운';}
		if ($row1[Skiresort] == 15){$Skiresort = '에덴벨리리조트';}
		if ($row1[Skiresort] == 16){$Skiresort = '오투리조트';}

		// $style001 = "font-size:15;weight:900;width:50px;padding-left:0px;padding-right:0px;padding-top:13px;padding-bottom:13px;border:2px solid #009c47;";
		// $style002 = "font-size:15;weight:900;width:50px;padding-left:0px;padding-right:0px;padding-top:13px;padding-bottom:13px;border:2px solid #ff1e00;";
		$style_gender = "font-size:12;weight:900;padding-left:3px;padding-right:3px;padding-top:0px;padding-bottom:0px;";

		// 점수 기준
		$cut_line = 70;
		$cut_line_total = 210;
?>

</head>
<body>

    <!--*******************
        Preloader start
    ********************-->
    <div id="preloader">
        <div class="sk-three-bounce">
            <div class="sk-child sk-bounce1"></div>
            <div class="sk-child sk-bounce2"></div>
            <div class="sk-child sk-bounce3"></div>
        </div>
    </div>
    <!--*******************
        Preloader end
    ********************-->


    <!--**********************************
        Main wrapper start
    ***********************************-->
    <div id="main-wrapper">

        <!--**********************************
            Nav header start
        ***********************************-->
        <div class="nav-header">
            <a href="../index.html" class="brand-logo">
                <img src="../images/sb_logo.png" width = 90%>
            </a>

            <div class="nav-control">
                <div class="hamburger">
                    <span class="line"></span><span class="line"></span><span class="line"></span>
                </div>
            </div>
        </div>
        <!--**********************************
            Nav header end
        ***********************************-->

		<?
		// 챗팅박스 + 헤드네비 불러오기
		include '_chat_box.html';
		include '_head_bar.html';

		// 좌측 네비게이션
	    include '_my_menu.html';
	    ?>


        <!--**********************************
            Content body start
        ***********************************-->
        <div class="content-body">
            <!-- container starts -->
            <div class="container-fluid">
                <!-- row -->

	<?
	// echo $query;
	echo "
	<div class='row'>
	<div class='col-xl-12'>
	<div class='tab-content'>
	<div id='All' class='tab-pane active fade show'>
	<div class='table-responsive'>
	<br><br><br>
	<div class = 'text-center'>";

	if ($history == 1)
		{echo "<span class = 'font32'>검정 및 시험 응시현황 (검정완료)</span><br>";}
  else
		{echo "<span class = 'font32'>검정 및 시험 응시현황</span><br>";}

	if ($The_No){echo "<br><span class = 'font24'>($Skiresort #$The_No / $row[Test_Date])</span>";}
	echo "
            </div>
            <br><br><br>

            <table id='example2' class='table card-table display dataTablesCard'>
	<thead>
              <tr align = center>
	    <th width = 160px>응시장소</th>
                <th width = 280px>시험정보</th>";

 		if ($ID == 'T1' or $ID == 'SBT1'){echo "<th width = 100px>스키장</th>";}

          		  echo "
  	     <th width = 120px>지원분야</th>
	     <th width = 340px>진행상태</th>
                 <th>시험결과</th>
              </tr>
            </thead>
	<tbody>";

 		while($row){
 		$i = $i + 1;

		$schedules_query = "select * from 7G_Master_Schedules where Test_id = '$row[TEST_ID]' and TEST_NO = '$row[Test_No]' order by Test_Date DESC" ;
		//echo $schedules_query;
		$schedules_result = mysqli_query($link, $schedules_query);
		$schedules = mysqli_fetch_array($schedules_result);

		$total_apply_query = "select * from 7G_Master_Apply where Test_id = '$row[TEST_ID]' and TEST_NO = '$row[Test_No]' and TRAN_STATUS != 2";
		//echo $total_apply_query;
	 	$total_apply_result = mysqli_query($link, $total_apply_query);
	 	$total_apply = mysqli_fetch_array(total_apply_result);
		$total_apply_count = mysqli_num_rows($total_apply_result);

		if ($row[SKIRESORT_NO] == 1){$Skiresort = '용평리조트';$Skiresort2 = '용평';}
		if ($row[SKIRESORT_NO] == 2){$Skiresort = '양지파인리조트'; $Skiresort2 = '양지';}
		if ($row[SKIRESORT_NO] == 4){$Skiresort = '무주덕유산리조트'; $Skiresort2 = '무주';}
		if ($row[SKIRESORT_NO] == 5){$Skiresort = '비발디파크'; $Skiresort2 = '비발디';}
		if ($row[SKIRESORT_NO] == 6){$Skiresort = '휘닉스파크'; $Skiresort2 = '휘닉스';}
		if ($row[SKIRESORT_NO] == 7){$Skiresort = '웰리힐리파크'; $Skiresort2 = '웰리힐리';}
		if ($row[SKIRESORT_NO] == 8){$Skiresort = '지산포레스트리조트'; $Skiresort2 = '지산';}
		if ($row[SKIRESORT_NO] == 9){$Skiresort = '엘리시안강촌'; $Skiresort2 = '강촌';}
		if ($row[SKIRESORT_NO] == 10){$Skiresort = '오크밸리'; $Skiresort2 = '오크밸리';}
		if ($row[SKIRESORT_NO] == 11){$Skiresort = '하이원리조트'; $Skiresort2 = '하이원';}
		if ($row[SKIRESORT_NO] == 12){$Skiresort = '곤지암리조트'; $Skiresort2 = '곤지암';}
		if ($row[SKIRESORT_NO] == 13){$Skiresort = '알펜시아'; $Skiresort2 = '알펜시아';}
		if ($row[SKIRESORT_NO] == 14){$Skiresort = '베어스타운';$Skiresort2 = '베어스';}
		if ($row[SKIRESORT_NO] == 15){$Skiresort = '에덴벨리리조트'; $Skiresort2 = '에덴벨리';}
		if ($row[SKIRESORT_NO] == 16){$Skiresort = '오투리조트'; $Skiresort2 = '오투';}

		if ($row[GENDER] == 1){$GENDER = "<span class='badge badge-pill badge-info' style = '$style_gender'>남</span>";}
		if ($row[GENDER] == 2){$GENDER = "<span class='badge badge-pill badge-danger' style = '$style_gender'>여</span>";}
		if ($row[GENDER] == 3){$GENDER = "<span class='badge badge-pill badge-success' style = '$style_gender'>관</span>";}

		$Testfee = number_format($row[Testfee]);

		$bottom_line = "border-bottom:1px solid #707070;";

		if($row[TEST_ID] =="SBT2" or $row[TEST_ID] =="T1" or $row[TEST_ID] =="T3" or $row[TEST_ID] =="T2" or $row[TEST_ID] =="PATROL"){
				$test_cut = $schedules[Participate]."명";
		}
		else{
			$test_cut = "제한없음";
		}
		echo "
		<tr>
		<td style = 'font-size:14pt'>
		<img src = 'resort-icon/".$row[SKIRESORT_NO].".jpg' width = 100%>
			";

		echo "	<a href = 'admin_member_edit.html?No=$row[NO]'>$img</a>
	    	</td>

		<td style = 'font-size:12pt' align = left>
		• 응시장소 : $Skiresort<br>
		• 응시번호 : $row[TEST_ID]-$row[Test_No]-$row[Apply_No]<br>
		<!-- • 시험정원 : 제한없음<br> -->
		• 시험정원 : $test_cut<br>
		<!-- • 신청인원 : $total_apply_count<b>-->
		• 시험일자 : $schedules[Test_Date]<br>
		<!-- • 시험시간 : $schedules[Time]<br> -->
		• 신청일자 : $row[Apply_date]
		</td>";

		if($ID == 'T1' or $ID == 'SBT1'){
		echo "<td width = 100px>
		<span class='btn btn-rounded btn-primary' style = 'font-size:12;weight:900;width:50px;padding-left:0px;padding-right:0px;'>$Skiresort2</span></td>";
		}

		echo "
		<td style = 'font-size:13pt' align = center>";

		if ($row[TEST_ID] == 'T1'){echo "<span class='btn btn-rounded btn-primary' style = 'font-size:13;weight:900;width:100px;padding-left:0px;padding-right:0px;'>스키티칭1</span>";}
		if ($row[TEST_ID] == 'T2'){echo "<span class='btn btn-rounded btn-primary' style = 'font-size:13;weight:900;width:100px;padding-left:0px;padding-right:0px;'>스키티칭2</span>";}
		if ($row[TEST_ID] == 'T3'){echo "<span class='btn btn-rounded btn-primary' style = 'font-size:13;weight:900;width:170px;padding-left:0px;padding-right:0px;'>스키기술선수권/티칭3</span>";}
		if ($row[TEST_ID] == 'SBT1'){echo "<span class='btn btn-rounded btn-vimeo' style = 'font-size:13;weight:900;width:130px;padding-left:0px;padding-right:0px;'>스노보드티칭1</span>";}
		if ($row[TEST_ID] == 'SBT2'){echo "<span class='btn btn-rounded btn-vimeo' style = 'font-size:13;weight:900;width:130px;padding-left:0px;padding-right:0px;'>스노보드티칭2</span>";}
		if ($row[TEST_ID] == 'SBT3'){echo "<span class='btn btn-rounded btn-vimeo' style = 'font-size:13;weight:900;width:130px;padding-left:0px;padding-right:0px;'>스노보드티칭3</span>";}
		if ($row[TEST_ID] == 'PATROL'){echo "<span class='btn btn-rounded btn-success' style = 'font-size:13;weight:900;width:130px;padding-left:0px;padding-right:0px;'>스키구조요원</span>";}

		echo "
		</td>
		<td style = 'font-size:14pt' align = center>";

		if ($row[PAYMENT_STATUS] == 0){echo "<span class='btn btn-rounded btn-primary' style = 'font-size:14;weight:900;width:100px;padding-left:0px;padding-right:0px;'>미결제</span>&nbsp;";}
		if ($row[PAYMENT_STATUS] == 2){echo "<span class='btn btn-rounded btn-vimeo' style = 'font-size:14;weight:900;width:100px;padding-left:0px;padding-right:0px;'>결제완료</span>&nbsp;";}

		if ($row[TRAN_STATUS] == 1){echo "<span class='btn btn-rounded btn-success' style = 'font-size:14;weight:900;width:100px;padding-left:0px;padding-right:0px;'>신청완료</span>&nbsp;";}
		if ($row[TRAN_STATUS] == 2){echo "<span class='btn btn-rounded btn-info' style = 'font-size:14;weight:900;width:100px;padding-left:0px;padding-right:0px;'>취소완료</span>&nbsp;";}
		if ($row[TRAN_STATUS] == 3){echo "<span class='btn btn-rounded btn-success' style = 'font-size:14;weight:900;width:100px;padding-left:0px;padding-right:0px;'>환불완료</span>&nbsp;";}
		if ($row[TRAN_STATUS] == 4){echo "<span class='btn btn-rounded btn-success' style = 'font-size:14;weight:900;width:100px;padding-left:0px;padding-right:0px;'>불참</span>&nbsp;";}
		if ($row[TRAN_STATUS] == 5){echo "<span class='btn btn-rounded btn-success' style = 'font-size:14;weight:900;width:100px;padding-left:0px;padding-right:0px;'>경기참석</span>&nbsp;";}
		if ($row[TRAN_STATUS] == 7){echo "<span class='btn btn-rounded btn-success' style = 'font-size:14;weight:900;width:100px;padding-left:0px;padding-right:0px;'>시험완료</span>&nbsp;";}
		if ($row[TRAN_STATUS] == 9){echo "<span class='btn btn-rounded btn-info' style = 'font-size:14;weight:900;width:100px;padding-left:0px;padding-right:0px;'>합격</span>&nbsp;";}

		echo "
		</td>
		<td align = center>";


		if ($row[TRAN_STATUS] == 7 and $ID == 'T1'){

		if ($row[T1_Score1] < $cut_line)
		{echo "<button type='button' class = 'btn btn-rounded light btn-danger' style = 'font-size:15;weight:900;width:110px;padding-left:0px;padding-right:0px;padding-top:13px;padding-bottom:13px;border:2px solid #ff1e00;'>$row[T_Score1]</button>&nbsp;";}
			else
		{echo "<button type='button' class = 'btn btn-rounded light btn-success' style = 'font-size:15;weight:900;width:110px;padding-left:0px;padding-right:0px;padding-top:13px;padding-bottom:13px;border:2px solid #009c47;'>$row[T_Score1]</button>&nbsp;";}

		if ($row[T1_Score2] < $cut_line)
		{echo "<button type='button' class = 'btn btn-rounded light btn-danger' style = 'font-size:15;weight:900;width:110px;padding-left:0px;padding-right:0px;padding-top:13px;padding-bottom:13px;border:2px solid #ff1e00;'>$row[T_Score2]</button>&nbsp;";}
			else
		{echo "<button type='button' class = 'btn btn-rounded light btn-success' style = 'font-size:15;weight:900;width:110px;padding-left:0px;padding-right:0px;padding-top:13px;padding-bottom:13px;border:2px solid #009c47;'>$row[T_Score2]</button>&nbsp;";}

		if ($row[T1_Score3] < $cut_line)
		{echo "<button type='button' class = 'btn btn-rounded light btn-danger' style = 'font-size:15;weight:900;width:110px;padding-left:0px;padding-right:0px;padding-top:13px;padding-bottom:13px;border:2px solid #ff1e00;'>$row[T_Score3]</button>&nbsp;";}
			else
		{echo "<button type='button' class = 'btn btn-rounded light btn-success' style = 'font-size:15;weight:900;width:110px;padding-left:0px;padding-right:0px;padding-top:13px;padding-bottom:13px;border:2px solid #009c47;'>$row[T_Score3]</button>&nbsp;";}

		if ($row[T_Total_Score] >= $cut_line_total){$row[T_Total_Score] = "합격 : $row[T_Total_Score]"; $bg_color4 = "btn btn-rounded light btn-success";} else {$row[T_Total_Score] = "탈락 : $row[T_Total_Score]";  $bg_color4 = "btn btn-rounded light btn-danger";}
		echo "<button type='button' class='$bg_color4'> $row[T_Total_Score]</button><br><br>";
		}

		if ($row[TRAN_STATUS] == 1){
			if ($row[TEST_ID] == 'T2'){
				//echo "<input type = 'submit' class='btn btn-rounded btn-primary' style = 'font-size:14;weight:900;width:100px;padding-left:0px;padding-right:0px;' value = '신청취소하기' onclick='cancle($row[Apply_No])'>";
				echo "<input type = 'submit' class='btn btn-rounded btn-primary' style = 'font-size:14;weight:900;width:100px;padding-left:0px;padding-right:0px;' value = '환불불가'>";
			}
			elseif($row[TEST_ID]=='T3'){
				//echo "<input type = 'submit' class='btn btn-rounded btn-primary' style = 'font-size:14;weight:900;width:100px;padding-left:0px;padding-right:0px;' value = '신청취소하기' onclick='cancle($row[Apply_No])'>";
				echo "<input type = 'submit' class='btn btn-rounded btn-primary' style = 'font-size:14;weight:900;width:100px;padding-left:0px;padding-right:0px;' value = '환불불가'>";
			}
			elseif($row[TEST_ID]=='SBT2'){
				//echo "<input type = 'submit' class='btn btn-rounded btn-primary' style = 'font-size:14;weight:900;width:100px;padding-left:0px;padding-right:0px;' value = '신청취소하기' onclick='cancle($row[Apply_No])'>";
				echo "<input type = 'submit' class='btn btn-rounded btn-primary' style = 'font-size:14;weight:900;width:100px;padding-left:0px;padding-right:0px;' value = '환불불가'>";
			}
			elseif($row[TEST_ID]=='PATROL'){
				//echo "<input type = 'submit' class='btn btn-rounded btn-primary' style = 'font-size:14;weight:900;width:100px;padding-left:0px;padding-right:0px;' value = '신청취소하기' onclick='cancle($row[Apply_No])'>";
				echo "<input type = 'submit' class='btn btn-rounded btn-primary' style = 'font-size:14;weight:900;width:100px;padding-left:0px;padding-right:0px;' value = '환불불가'>";
			}
			else{
				//echo "<input type = 'submit' class='btn btn-rounded btn-primary' style = 'font-size:14;weight:900;width:100px;padding-left:0px;padding-right:0px;' value = '신청취소하기' onclick='cancle($row[Apply_No])'>";
			}
		}



	echo "	</td>
		</tr>";

 		  $row=mysql_fetch_array($result);
   		}

   echo "</tbody></table><br>";

	//Mobile 과 Pc 구분
		$mobile_agent = "/(iPod|iPhone|Android|BlackBerry|SymbianOS|SCH-M\d+|Opera Mini|Windows CE|Nokia|SonyEricsson|webOS|PalmOS)/";
		if(preg_match($mobile_agent, $_SERVER['HTTP_USER_AGENT'])){
			$nextUrl = "Mobile";
		}else{
			$nextUrl = "Pc";
		}


	?>

	</tbody>
	</table>
	</div>
	</div>


                <!-- Row ends -->
            </div>
            <!-- container ends -->
        </div>
        <!--**********************************
                Content body end
            ***********************************-->


        <!--**********************************
            Footer start
        ***********************************-->
        <!-- <div class="footer">
            <div class="copyright">
                <p>© Designed &amp; Developed by <a href="https://7gate.kr/" target="_blank">podong28.com</a> 2019</p>
            </div>
        </div> -->
        <!--**********************************
            Footer end
        ***********************************-->


    </div>
    <!--**********************************
        Main wrapper end
    ***********************************-->

    <!--**********************************
        Scripts
    ***********************************-->
    <!-- Required vendors -->
    <script src="./vendor/global/global.min.js"></script>
	<script src="./vendor/bootstrap-select/dist/js/bootstrap-select.min.js"></script>
    <script src="./js/custom.min.js"></script>
	<script src="./js/deznav-init.js"></script>

	<!-- Datatable -->
    <script src="./vendor/datatables/js/jquery.dataTables.min.js"></script>
	<script>
		(function($) {
			var table = $('#example2').DataTable({
				searching: false,
				paging:true,
				select: false,
				//info: false,
				lengthChange:false

			});
			var table = $('#example3').DataTable({
				searching: false,
				paging:true,
				select: false,
				//info: false,
				lengthChange:false

			});
			var table = $('#example4').DataTable({
				searching: false,
				paging:true,
				select: false,
				//info: false,
				lengthChange:false

			});
			var table = $('#example5').DataTable({
				searching: false,
				paging:true,
				select: false,
				//info: false,
				lengthChange:false

			});
			$('#example tbody').on('click', 'tr', function () {
				var data = table.row( this ).data();

			});
		})(jQuery);
	</script>
	
	<script>

	function cancle(num){
		if (confirm('본 신청을 정말 취소하시겠습니까?(환불 대상인 경우 취소 후 2주 정도가 소요됩니다)') == true){    
		location.href='myTest_cancle.php?MID='+num;
		}
		else{ 
    	return;
		}
	}
        
	function cancel(num){
		var READY_API_URL = "<?=$READY_API_URL?>";

		if (confirm('본 신청을 정말 취소하시겠습니까?(환불 대상인 경우 시험 종료 후 15일 이내에 일괄 처리됩니다.') == true){    

			var request = Mainpay.ready(READY_API_URL);
		request.done(function(response) {
			alert(JSON.stringify(response));
			if (response.resultCode == '200') {
				/* 결제창 호출 */

				Mainpay.open(response.data.next<?=$nextUrl?>Url); //*주의* PC와 Mobile은 URL이 상이합니다.
				return false;
			}
			else{
				alert("앗 죄송합니다. 이미 신청했거나 다른 이유로 결제가 되지않았습니다.\n 잠시뒤에 다시 시도해주세요.");	
			alert("ERROR. : "+JSON.stringify(response));
			}
		});			

		}
		else{ 
    	return;
		}
	}        


    </script>";

	
	
</body>
</html>
