<?php
    header('Content-Type: text/html; charset=utf-8');
	   $READY_API_URL = "pc/exam_ready.php";

	   // 변수값 넘거받기
	   include 'db_config.html';

	   extract($_REQUEST);
	   $Date = date('Ymd');
	   $Test_No = $No;

	   if ($type == 'T1'){$Test_Name = '스키 티칭1'; $Test_Table = '7G_T1_Schedules'; $Apply_Table = '7G_T1_Apply'; $Product_Name = 'SKI-Teaching1'; $REF_NO = "TA";}
	   if ($type == 'T2'){$Test_Name = '스키 티칭2'; $Test_Table = '7G_T2_Schedules'; $Apply_Table = '7G_T2_Apply'; $Product_Name = 'SKI-Teaching2'; $REF_NO = "TB";}
	   if ($type == 'T3'){$Test_Name = '스키 티칭3 & 기술선수권대회'; $Test_Table = '7G_T3_Schedules'; $Apply_Table = '7G_T3_Apply'; $Product_Name = 'SKI-Teaching3'; $REF_NO = "TC";}

	   if ($type == 'SBT1'){$Test_Name = '스노보드 티칭1'; $Test_Table = '7G_SBT1_Schedules'; $Apply_Table = '7G_SBT1_Apply'; $Product_Name = 'SB-Teaching1'; $REF_NO = "SA";}
	   if ($type == 'SBT2'){$Test_Name = '스노보드 티칭2'; $Test_Table = '7G_SBT2_Schedules'; $Apply_Table = '7G_SBT2_Apply';  $Product_Name = 'SB-Teaching2'; $REF_NO = "SB";}
	   if ($type == 'SBT3'){$Test_Name = '스노보드 티칭3 & 기술선수권대회'; $Test_Table = '7G_SBT3_Schedules'; $Apply_Table = '7G_SBT3_Apply';  $Product_Name = 'SB-Teaching3'; $REF_NO = "SC";}

	   if ($type == 'PATROL'){$Test_Name = '스키구조요원'; $Test_Table = '7G_Patrol_Schedules'; $Apply_Table = '7G_Patrol_Apply';  $Product_Name = 'PATROL'; $REF_NO = "P";}

	   // 신청테이블에 이번 신청내용이 등록되어 있는지 체크
	   $dup_query	= "SELECT * FROM 7G_Master_Apply where Test_id = '$type' and TEST_NO = '$No' and MEMBER_ID = '$Login_User_ID' and PAYMENT_STATUS = 2";
	   $dup_result	= mysql_query($dup_query,$connect);
	   $dup_check	= mysql_fetch_array($dup_result);
	   $dup_total_record = mysql_num_rows($dup_result);

    // 검정일정 불러오기 (건별)
    $query1		= "SELECT * FROM 7G_Master_Schedules where Test_id = '$type' and TEST_NO = '$No'";
	   $result1	= mysql_query($query1,$connect);
	   $row1		= mysql_fetch_array($result1);

    // 회원정보 불러오기
	   $query		= "SELECT * FROM 7G_Skiresort_Member where MEMBER_ID = '$Login_User_ID'";
	   $result		= mysql_query($query,$connect );
	   $member		= mysql_fetch_array($result);

    // 거래번호 생성을 위한 기존 거래내역 총 건수 조회
	   $query		= "SELECT * FROM 7G_Master_Apply where MEMBER_ID = '$Login_User_ID'";
	   $result		= mysqli_query($link, $query);
	   $count		= mysqli_num_rows($result) + 1;
	   $length 	= strlen($count);
	   if($length == 1){$count = "00".$count;}
	   if($length == 2){$count = "0".$count;}
	   if($length == 3){$count = $count;}

	   $mbrRefNo = $REF_NO.$member['NO'].'-'.$count; // 주문번호
		
		// 스마트로 기본세팅값
		include_once $_SERVER['DOCUMENT_ROOT']."/pay/smatro.inc.php";

	   // SPC PG의 결제가 (또는 결제창이 클로즈) 완료 또는 실패했을때 처리하는 스크립트 (매우 중요)
	   echo "<script>function mainpay_close_event(){top.document.location.href = '../mypage/payment_result.html?REF_NO=$mbrRefNo';}</script>";

?>

<!DOCTYPE html>
<html>

<head>

	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
	<link rel="shortcut icon" href="Myicon.png" type="image/x-icon">

	<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
	<script src="https://api-std.mainpay.co.kr/js/mainpay.pc-1.1.js"></script>

	<script type='text/javascript'>
	var READY_API_URL = "<?=$READY_API_URL?>";

	function payment() {

		$('.wrap-loading').removeClass('display-none');

  var reg_email = /^([0-9a-zA-Z_\.-]+)@([0-9a-zA-Z_-]+)(\.[0-9a-zA-Z_-]+){1,2}$/;
		var eMail = document.getElementById("BuyerEmail").value;
		var ZIP = document.getElementById("sample6_postcode").value;
		var ADDR2 = document.getElementById("sample6_detailAddress").value;

		if (!eMail){alert('이메일 주소를 입력해 주세요 !!!'); return; }
		if(!reg_email.test(eMail)) { alert('이메일 주소가 유효하지 않습니다. !!!'); return; }
		if (!ZIP){alert('배송지 우편번호를 입력해 주세요 !!!'); return; }
		if (!ADDR2){alert('배송지 상세주소를 입력해 주세요 !!!'); return; }
		
		if(!$('input[name=PayMethods]').is(':checked')){
			alert('결재방법을 선택해 주세요.');return;
		} 
		document.tranMgr.PayMethod.value = $("input[name='PayMethods']:checked").val();

		showLayer();
		document.tranMgr.submit();

		/*
		var request = Mainpay.ready(READY_API_URL);
		request.done(function(response) {
			if (response.resultCode == '200') {
				// 결제창 호출 
				Mainpay.open(response.data.nextPcUrl); //*주의* PC와 Mobile은 URL이 상이합니다.
				return false;
			}
			alert("ERROR : "+JSON.stringify(response));
		});
		*/
	}
	window.onpopstate = function(){ history.go(-1)};

	function go_back(){top.document.location.href = '$return_page'}

    function sample6_execDaumPostcode() {
        new daum.Postcode({
            oncomplete: function(data) {
                // 팝업에서 검색결과 항목을 클릭했을때 실행할 코드를 작성하는 부분.

                // 각 주소의 노출 규칙에 따라 주소를 조합한다.
                // 내려오는 변수가 값이 없는 경우엔 공백('')값을 가지므로, 이를 참고하여 분기 한다.
                var addr = ''; // 주소 변수
                var extraAddr = ''; // 참고항목 변수

                //사용자가 선택한 주소 타입에 따라 해당 주소 값을 가져온다.
                if (data.userSelectedType === 'R') { // 사용자가 도로명 주소를 선택했을 경우
                    addr = data.roadAddress;
                } else { // 사용자가 지번 주소를 선택했을 경우(J)
                    addr = data.jibunAddress;
                }

                // 사용자가 선택한 주소가 도로명 타입일때 참고항목을 조합한다.
                if(data.userSelectedType === 'R'){
                    // 법정동명이 있을 경우 추가한다. (법정리는 제외)
                    // 법정동의 경우 마지막 문자가 "동/로/가"로 끝난다.
                    if(data.bname !== '' && /[동|로|가]$/g.test(data.bname)){
                        extraAddr += data.bname;
                    }
                    // 건물명이 있고, 공동주택일 경우 추가한다.
                    if(data.buildingName !== '' && data.apartment === 'Y'){
                        extraAddr += (extraAddr !== '' ? ', ' + data.buildingName : data.buildingName);
                    }
                    // 표시할 참고항목이 있을 경우, 괄호까지 추가한 최종 문자열을 만든다.
                    if(extraAddr !== ''){
                        extraAddr = ' (' + extraAddr + ')';
                    }
                    // 조합된 참고항목을 해당 필드에 넣는다.
                    document.getElementById("sample6_extraAddress").value = extraAddr;

                } else {
                    document.getElementById("sample6_extraAddress").value = '';
                }

                // 우편번호와 주소 정보를 해당 필드에 넣는다.
                document.getElementById('sample6_postcode').value = data.zonecode;
                document.getElementById("sample6_address").value = addr;
                // 커서를 상세주소 필드로 이동한다.
                document.getElementById("sample6_detailAddress").focus();
            }
        }).open();
    }

	</script>

	<?

	if (!$Login_User_ID){echo " <script language='javascript'>alert('로그인이 필요한 서비스 입니다.');top.document.location.href = 'member_login.html?case=9'</script>";}

	if ($row1[Skiresort] == 1){$Skiresort = '용평리조트';}
	if ($row1[Skiresort] == 2){$Skiresort = '양지파인리조트';}
	if ($row1[Skiresort] == 3){$Skiresort = '스타힐리조트';}
	if ($row1[Skiresort] == 4){$Skiresort = '무주덕유산리조트';}
	if ($row1[Skiresort] == 5){$Skiresort = '비발디파크';}
	if ($row1[Skiresort] == 6){$Skiresort = '피닉스평창';}
	if ($row1[Skiresort] == 7){$Skiresort = '월리힐리파크';}
	if ($row1[Skiresort] == 8){$Skiresort = '지산포레스트리조트';}
	if ($row1[Skiresort] == 9){$Skiresort = '엘리시안강촌';}
	if ($row1[Skiresort] == 10){$Skiresort = '오크밸리';}
	if ($row1[Skiresort] == 11){$Skiresort = '하이원리조트';}
	if ($row1[Skiresort] == 12){$Skiresort = '곤지암리조트';}
	if ($row1[Skiresort] == 13){$Skiresort = '알펜시아';}
	if ($row1[Skiresort] == 14){$Skiresort = '베어스타운';}
	if ($row1[Skiresort] == 15){$Skiresort = '에덴벨리리조트';}
	if ($row1[Skiresort] == 16){$Skiresort = '오투리조트';}

	$test_date = $row1[Test_Date]." ($row1[Time])";

	$Product_Name = $Product_Name." ($member[MEMBER_NAME]님-".$member[NO].")";

	if ($dup_check[Apply_date] == ''){$dup_check[Apply_date] = $today;}

	$buyerName        = $member[MEMBER_NAME];	// 구매자명
	$buyerTel         = $member[PHONE];			// 구매자연락처
	$buyerEmail       = $member[EMAIL];			// 구매자메일주소
?>

</head>
<body>
        <div class="ofl_spt">
            <script language="javascript">
                $(document).ready(function() {
                    //메인화면 PC/모바일 분기시 화면 스크롤
                    isOnePageScroll();
                });
            </script>
        </div>

		<? include "link-files.html";
           include "main_nav2.html";
		   $current_page = "test_apply.html?type=$type";
           include 'header_sub_page.html';
        ?>

        <div id="scroll_top" >
            <button type="button"><img src="images/scr_top.jpg"></button>
        </div>
        <div>


<?	echo "
			<br><br><br><br>
    		<div class='container' style = 'padding:0px;'>
      			<div class='row'>
        			<div class='col-lg-12 text-center'>
          				<p class = 'font32'>한국스키장경영협회 $Test_Name 검정신청 및 응시료 결제</p>
          				<p class='font12' style = 'color:red;font-weight:700;'>결제과정이 종료되어야 검정신청이 완료됩니다.</p>
        			</div>
      			</div>
      		</div>
			<br><br>

    		<div class='container'>

		<form id='tranMgr' name='tranMgr' method='post'  target='proc' action='/pay/process.php' >
		
		<input type='hidden' name='mode' value='payment0' hidden>
		<input type='hidden' name='GoodsCnt' value='1' hidden>
		<input type='hidden' name='Mid' maxlength='10' value='$Mid' placeholder=''/>
		<input type='hidden' name='ReturnUrl'  class='input' value='$ReturnUrl'>
		<input type='hidden' name='StopUrl'  class='input' value='$ReturnUrl' placeholder='Mobile 연동 시 필수'/>
		<input type='hidden' name='MallIp'  class='input' value='$_SERVER[REMOTE_ADDR]'>
		<input type='hidden' name='EncryptData'  class='input' value='$EncryptData'>
		<input type='hidden' name='EdiDate'  class='input' value='$EdiDate'>
		<input type='hidden' name='PayMethod' >	
		<input type='hidden' name='MallReserved' value='payment0'>			

		<input name='Test_No' type='text' value='$Test_No' hidden>
		<input name='type' type='text' value='$type' hidden>


                <br><br><br><br>
                <table style = 'height:35px;border-bottom:1px solid #888888;' width = 100% >
        		<tr><td class = 'font16' align = center style = 'background-color:#000000;color:#FFFFFF;width:130px;font-weight:700;'>결제자 정보</td><td></td></tr></table><br><br>


                <div class='form-group' >
						<div class='input-group'>
  							<div class='input-group-prepend'>
								<button class='btn btn-info border-dark' type='button' style = 'width:130px;'>성명</button>
  							</div>
								<input class='form-control'  type='text' name='BuyerName' value = '$member[MEMBER_NAME]' style = 'height:50px;' readonly>
								<input class='form-control'  type='text' name='MEMBER_ID' value = '$member[MEMBER_ID]' hidden>
								<input class='form-control'  type='text' name='MEMBER_NO' value = '$member[NO]' hidden>
								<input class='form-control'  type='text' name='Test_No' value = '$Test_No' hidden>
								<input class='form-control'  type='text' name='Skiresort_No' value = '$row1[Skiresort]' hidden>
						</div>
                </div>

                <div class='form-group'>
						<div class='input-group'>
  							<div class='input-group-prepend'>
								<button class='btn btn-info border-dark' type='button' style = 'width:130px;'>핸드폰</button>
  							</div>
								<input class='form-control'  type='text' name='BuyerTel' value = '$member[PHONE]' style = 'height:50px;' readonly>
						</div>
                </div>

                <div class='form-group' >
						<div class='input-group'>
  							<div class='input-group-prepend'>
								<button class='btn btn-info border-dark' type='button' style = 'width:130px;'>이메일</button>
  							</div>
								<input class='form-control'  type='text' id = 'BuyerEmail' name='BuyerEmail' value = '$member[EMAIL]' style = 'height:50px;'>
						</div>
                </div>

                <div class='form-group'>
						<div class='input-group'>
  							<div class='input-group-prepend'>
								<button class='btn btn-info border-dark' type='button' style = 'width:130px;'>신청일자</button>
  							</div>
								<input class='form-control'  type='text' name='Apply_date' value = '$dup_check[Apply_date]' style = 'height:50px;' readonly>
						</div>
                </div>

                <br><br>

                <table style = 'height:35px;border-bottom:1px solid #888888;' width = 100% >
        		<tr><td class = 'font16' align = center style = 'background-color:#000000;color:#FFFFFF;width:130px;font-weight:700;'>회원사진</td><td></td></tr></table><br><br>";

        		if($member[image]){echo "<img class='rounded' height = 200px src = 'view3.html?id=$Login_User_ID'>&nbsp;&nbsp;"; $photo = 'new';}
        		if($member[PHOTO3]){echo "<img class='rounded' height = 200px  src = 'data/$row[PHOTO3]'>&nbsp;"; $photo = 'old';}
        		if(!$member[image] and !$member[PHOTO3]){echo "<img class='rounded' height = 200px  src = 'data/no_image.jpg'>&nbsp;";}

				echo "<br><br>
				<input type ='text' id = 'photo' name = 'photo' value = '$photo' hidden>

				 <div class='form-group' style='padding-left:10px'>
						<div class='input-group'>
  							<div class='input-group-prepend'>
								<button class='btn btn-info' type='button' style = 'width:120px;'>사진등록</button>
  							</div>
								<input class='form-control' type='file' id = 'photo2' name='image' placeholder='이미지를 선택해 주세요 (6M Byte 이하)'>
						</div>
                </div>

				<br><br><br>
                <table style = 'height:35px;border-bottom:1px solid #888888;' width = 100% >
        		<tr><td class = 'font16' align = center style = 'background-color:#000000;color:#FFFFFF;width:130px;font-weight:700;'>검정&결제내용</td><td></td></tr></table><br><br>

                <div class='form-group' >
						<div class='input-group'>
  							<div class='input-group-prepend'>
								<button class='btn btn-info border-dark' type='button' style = 'width:130px;'>결제방법</button>
  							</div>
							<div class='form-check' style='margin-left:12px''>
							  <input class='form-check-input' type='radio' name='PayMethods' id='flexRadioDefault1' value='CARD' style='width:30px;-webkit-appearance:auto' >
							  <label class='form-check-label' for='flexRadioDefault1' style='line-height: 37px;font-size: 1rem;margin-left:20px;'>신용카드</label>
							</div>
							<div class='form-check' style='margin-left:12px;'>
							  <input class='form-check-input' type='radio' name='PayMethods' id='flexRadioDefault2' value='BANK'  style='width:30px;-webkit-appearance:auto'>
							  <label class='form-check-label' for='flexRadioDefault2' style='line-height: 37px;font-size: 1rem;margin-left:20px;'>계좌이체</label>
							</div>
								<!--
								<select class='form-control' id = 'Payment_Method' name = 'paymethod' style = 'height:50px;'>
									<option value = ''>응시료결제방법</option>
									<option value = ''>-----------------------------------</option>
									<option value = 'CARD' selected>신용카드</option>
									<option value = 'VBANK'>가상계좌입금</option>
									<option value = 'BANK'>일반무통장입금</option>
						        </select>
								-->
						</div>
      </div>";

				echo "
                <div class='form-group'>
						<div class='input-group'>
  							<div class='input-group-prepend'>
								<button class='btn btn-info border-dark' type='button' style = 'width:130px;'>결제항목</button>
  							</div>
								<input class='form-control'  type='text' name='GoodsName' value = '$Product_Name' style = 'height:50px;' readonly>
						</div>
                </div>

                <div class='form-group'>
						<div class='input-group'>
  							<div class='input-group-prepend'>
								<button class='btn btn-info border-dark' type='button' style = 'width:130px;'>시험장소</button>
  							</div>
								<input class='form-control'  type='text'  name='Skiresort2' value = '$Skiresort (시험번호 : $Test_No)' style = 'height:50px;' readonly>
						</div>
                </div>

                <div class='form-group'>
						<div class='input-group'>
  							<div class='input-group-prepend'>
								<button class='btn btn-info border-dark' type='button' style = 'width:130px;'>시험일시</button>
  							</div>
								<input class='form-control'  type='text'  name='Test_Date' value = '$test_date' style = 'height:50px;' readonly>
						</div>
                </div>

                <div class='form-group'>
						<div class='input-group'>
  							<div class='input-group-prepend'>
								<button class='btn btn-info border-dark' type='button' style = 'width:130px;'>응시료/결제금액</button>
  							</div>
								<input class='form-control'  type='text' id = 'Amt' name='Amt' value = '$row1[Testfee]' style = 'height:50px;' readonly>
						</div>
                </div>


                <div class='form-group'>
						<div class='input-group'>
  							<div class='input-group-prepend'>
								<button class='btn btn-info border-dark' type='button' style = 'width:130px;'>주문번호</button>
  							</div>
								<input class='form-control'  type='text' id = 'REF_NO' name='REF_NO' value = '$mbrRefNo' style = 'height:50px;' readonly>
						</div>
                </div>


                <br><br>
                <table style = 'height:35px;border-bottom:1px solid #888888;' width = 100% >
        		<tr><td class = 'font16' align = center style = 'background-color:#000000;color:#FFFFFF;width:130px;font-weight:700;'>배송지정보</td><td></td></tr></table><br><br>


                <div class='form-group' >
						<div class='input-group'>
  							<div class='input-group-prepend'>
								<button class='btn btn-info border-dark' type='button' style = 'width:130px;'>우편번호</button>
  							</div>
								<input class='form-control' type='text' name='ZIP' id='sample6_postcode' value = '$member[ZIP]' placeholder='우편번호' style = 'height:50px;'>&nbsp;&nbsp;<input type='button' class ='btn-orange' onclick='sample6_execDaumPostcode()' value='우편번호 찾기' width='100' style = 'height:50px;'>
						</div>
                </div>

                <div class='form-group' >
						<div class='input-group'>
  							<div class='input-group-prepend'>
								<button class='btn btn-info border-dark' type='button' style = 'width:130px;'>주소1</button>
  							</div>
								<input class='form-control'  type='text' id='sample6_address' placeholder='주소1' name = 'ADDRESS1' value = '$member[ADDRESS1]' readonly style = 'height:50px;'>
						</div>
                </div>

                <div class='form-group' >
						<div class='input-group'>
  							<div class='input-group-prepend'>
								<button class='btn btn-info border-dark' type='button' style = 'width:130px;'>상세주소</button>
  							</div>
								<input class='form-control'  type='text' id='sample6_detailAddress'  name = 'ADDRESS2' value = '$member[ADDRESS2]' placeholder='상세주소' style = 'height:50px;'>
						</div>
                </div>

                <div class='form-group' >
						<div class='input-group'>
  							<div class='input-group-prepend'>
								<button class='btn btn-info border-dark' type='button' style = 'width:130px;'>참고항목</button>
  							</div>
								<input class='form-control'  type='text' id='sample6_extraAddress' placeholder='참고항목' name = 'ADDRESS3' value = '$member[ADDRESS3]' readonly style = 'height:50px;'>
						</div>
                </div>

			</div>

                ";

?>


				</form>
			</div>
		</div>
	</div>


	<div class='container text-right' style = 'padding:10px;'>
		&nbsp;<button class='btn-blue' style = 'height:50px;width:100px;' onclick='go_back()';>이전 페이지</button>&nbsp;


<?

		if ($type == 'T1' or $type == 'SBT1')
			{
				if($dup_check[Process] == '0' or $dup_check[Process] == ''  )
					{echo"&nbsp;<button class='btn-black' style = 'height:50px;width:100px;' onclick='payment2()';>$type 시험신청</button>";}
				else
					{echo"&nbsp;<button class='btn-black' style = 'height:50px;width:100px;' onclick='payment2()';>완료</button>";}


			}

		if ($type == 'T2' or $type == 'T3' or $type == 'SBT2' or $type == 'SBT3' or $type == 'PATROL' )
			{

				if ($dup_total_record == 0){echo "&nbsp;<button class='btn-black' style = 'height:50px;width:150px;' onclick='payment()';>시험신청/응시료결제</button>";}
				if ($dup_total_record > 0){echo "&nbsp;<button class='btn-red' style = 'height:50px;width:150px;'>신청완료(신청불가)</button>";}


			}

?>

	</div>
	<br><br><br>

<?

if ($process == '1' and $type != 'SBT1' and $type != 'T1'){echo "<script>alert('응시료 결제를 위해 신청하신 내용을 다시 한번 확인해 주십시오.')</script>";}

	include 'footer.html';

?>

		</body>
	</html>

<div id="fade" class="black_background"></div>
<div id="light" class="white_content">
  <div style='text-align:center'><img src='/img/lodingImg.gif' /></div>
</div>

   <style>
        .black_background{
            display: none;
            position: absolute;
            top: 0%;
            left: 0%;
            width: 100%;
            height: 100%;
            background: #666666 ;
            z-index:1001;
            -moz-opacity: 0.8;
            opacity:.80;
            filter: alpha(opacity=60);
        }

        .white_content {
            display: none;
            position: absolute;
		    background-color: transparent;
            z-index:1002;
            overflow: auto;
        }

    </style>
<script type="text/javascript">

    function wrapWindowByMask() {
      //화면의 높이와 너비를 구한다.
      var maskHeight = $(document).height();
      var maskWidth = $(window).width();

      //마스크의 높이와 너비를 화면 것으로 만들어 전체 화면을 채운다.
      $('#fade').css({ 'width': maskWidth, 'height': maskHeight });
    }

    /// 화면의 중앙에 레이어띄움
    function showLayer() {
      wrapWindowByMask();

      $("#light").css("position", "absolute");
      $("#light").css("top", Math.max(0, (($(window).height() - $("#light").outerHeight()) / 2) + $(window).scrollTop() - 100) + "px");
      $("#light").css("left", Math.max(0, (($(window).width() - $("#light").outerWidth()) / 2) + $(window).scrollLeft()) + "px");

      $('#fade').show();
      $('#light').show();
    }
	
	

    function clolse() {
      $('#fade').hide();
      $('#light').hide();
    }

</script>